NODE mv
SQL >

    SELECT
        toStartOfMinute(timestamp) AS t,
        name AS player_id,
        uniqState(session_id) AS n_games,
        countIfState(type = 'score') AS scores,
        countIfState(type = 'purchase') AS purchases
    FROM events_api
    GROUP BY
        t,
        player_id

TYPE materialized
DATASOURCE mv_stats_by_min
ENGINE "AggregatingMergeTree"
ENGINE_PARTITION_KEY "toYYYYMM(t)"
ENGINE_SORTING_KEY "player_id, t"

