NODE mv
SQL >

    SELECT
        toStartOfMinute(timestamp) AS t,
        uniqState(name) AS n_players,
        uniqState(session_id) AS n_games,
        countIfState(type = 'score') AS scores,
        countIfState(type = 'purchase') AS purchases
    FROM confluent_events
    GROUP BY t

TYPE materialized
DATASOURCE mv_stats_by_min
ENGINE "AggregatingMergeTree"
ENGINE_PARTITION_KEY "toYYYYMM(t)"
ENGINE_SORTING_KEY "t"

